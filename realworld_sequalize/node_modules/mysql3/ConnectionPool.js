"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ConnectionPool = void 0;

var mysql = _interopRequireWildcard(require("mysql"));

var _Sql = require("./Sql");

var _cliHighlight = _interopRequireDefault(require("cli-highlight"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function typeCast(field, next) {
  switch (field.type) {
    case 'DATE':
    case 'DATETIME':
    case 'DATETIME2':
    case 'NEWDATE':
    case 'TIMESTAMP':
    case 'TIMESTAMP2':
      return field.string();

    case 'LONGLONG':
      const numberString = field.string();
      return numberString === null ? null : BigInt(numberString);

    case 'BIT':
      if (field.length === 1) {
        const buf = field.buffer();
        return buf === null ? null : buf[0] === 1;
      }

      break;
  }

  return next();
}

class ConnectionPool {
  constructor(config) {
    this.config = {
      timezone: 'Z',
      charset: 'utf8mb4',
      typeCast,
      ...config
    };
    let {
      sqlMode,
      foreignKeyChecks,
      safeUpdates,
      printQueries,
      initSql,
      ...other
    } = this.config;
    this.pool = mysql.createPool(other);
    const connQueries = initSql ? [...initSql] : [];

    if (sqlMode != null) {
      connQueries.push(_Sql.sql`SET sql_mode=${Array.isArray(sqlMode) ? sqlMode.join(',') : sqlMode}`);
    }

    if (foreignKeyChecks != null) {
      connQueries.push(_Sql.sql`SET foreign_key_checks=${foreignKeyChecks ? 1 : 0}`);
    }

    if (safeUpdates) {
      connQueries.push(_Sql.sql`SET sql_safe_updates=${safeUpdates ? 1 : 0}`);
    }

    if (connQueries.length) {
      this.pool.on('connection', _conn => {
        const conn = this._wrap(_conn);

        for (const query of connQueries) {
          conn.query(query);
        }
      });
    }
  }

  query(query) {
    return this.withConnection(conn => conn.query(query));
  }

  async row(query) {
    const rows = await this.query(_Sql.sql`select * from (${query}) _query limit 1`);
    return rows.length ? rows[0] : null;
  }

  async value(query) {
    const row = await this.row(query);
    if (!row) return null;
    const keys = Object.keys(row);
    if (keys.length !== 1) throw new Error(`Expected exactly 1 field in query, got ${keys.length}`);
    return row[keys[0]];
  }

  async exists(query) {
    return Boolean((await this.value(_Sql.sql`select exists(${query})`)));
  }

  exec(query) {
    return this.withConnection(conn => conn.query(query));
  }

  async *stream(query) {
    const sql = query.toSqlString();

    if (this.config.printQueries) {
      const hisql = (0, _cliHighlight.default)(sql, {
        language: 'sql',
        ignoreIllegals: true
      });
      console.log(hisql);
    }

    let results = [];
    let resolve;
    let promise = new Promise(r => resolve = r);
    let done = false;
    this.pool.query(sql).on('error', err => {
      throw err;
    }).on('result', row => {
      results.push(row);
      resolve();
      promise = new Promise(r => resolve = r);
    }).on('end', () => {
      done = true;
      resolve();
    });

    for (;;) {
      await promise;
      yield* results;
      if (done) break;
      results = [];
    }
  }

  withConnection(callback) {
    return new Promise((resolve, reject) => {
      this.pool.getConnection(async (err, conn) => {
        if (err) return reject(err);

        try {
          resolve(callback(this._wrap(conn)));
        } finally {
          conn.release();
        }
      });
    });
  }

  transaction(callback) {
    if (Array.isArray(callback)) {
      return this.transaction(async conn => {
        const results = await Promise.allSettled(callback.map(sql => conn.query(sql)));
        const mapped = zip(callback, results).map((x, i) => ({
          index: i,
          query: x[0],
          result: x[1]
        }));
        const errors = mapped.filter(r => r.result.status === 'rejected');
        if (errors.length) throw Error(`${errors.length} quer${errors.length === 1 ? 'y' : 'ies'} failed:${errors.map(err => `\n[${err.index}] ${err.query.toSqlString()} :: ${err.result.reason}`).join('')}`);
        return results;
      });
    }

    return this.withConnection(async conn => {
      await conn.query(_Sql.sql`START TRANSACTION`);
      let result;

      try {
        result = await callback(conn);
      } catch (err) {
        await conn.query(_Sql.sql`ROLLBACK`);
        throw err;
      }

      await conn.query(_Sql.sql`COMMIT`);
      return result;
    });
  }

  _wrap(conn) {
    return new PoolConnection(conn, !!this.config.printQueries);
  }

  close() {
    return new Promise((resolve, reject) => {
      this.pool.end(err => {
        if (err) return reject(err);
        resolve();
      });
    });
  }

}

exports.ConnectionPool = ConnectionPool;

function zip(a, b) {
  if (a.length !== b.length) throw new Error("Cannot zip arrays; lengths differ");
  return a.map((x, i) => [x, b[i]]);
}

class PoolConnection {
  constructor(conn, printQueries) {
    this.conn = conn;
    this.printQueries = printQueries;
  }

  query(query) {
    return new Promise((resolve, reject) => {
      const sql = query.toSqlString();

      if (this.printQueries) {
        const hisql = (0, _cliHighlight.default)(sql, {
          language: 'sql',
          ignoreIllegals: true
        });
        console.log(hisql);
      }

      this.conn.query(sql, (error, results, fields) => {
        if (error) return reject(error);
        resolve(results);
      });
    });
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25uZWN0aW9uUG9vbC50cyJdLCJuYW1lcyI6WyJ0eXBlQ2FzdCIsImZpZWxkIiwibmV4dCIsInR5cGUiLCJzdHJpbmciLCJudW1iZXJTdHJpbmciLCJCaWdJbnQiLCJsZW5ndGgiLCJidWYiLCJidWZmZXIiLCJDb25uZWN0aW9uUG9vbCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwidGltZXpvbmUiLCJjaGFyc2V0Iiwic3FsTW9kZSIsImZvcmVpZ25LZXlDaGVja3MiLCJzYWZlVXBkYXRlcyIsInByaW50UXVlcmllcyIsImluaXRTcWwiLCJvdGhlciIsInBvb2wiLCJteXNxbCIsImNyZWF0ZVBvb2wiLCJjb25uUXVlcmllcyIsInB1c2giLCJzcWwiLCJBcnJheSIsImlzQXJyYXkiLCJqb2luIiwib24iLCJfY29ubiIsImNvbm4iLCJfd3JhcCIsInF1ZXJ5Iiwid2l0aENvbm5lY3Rpb24iLCJyb3ciLCJyb3dzIiwidmFsdWUiLCJrZXlzIiwiT2JqZWN0IiwiRXJyb3IiLCJleGlzdHMiLCJCb29sZWFuIiwiZXhlYyIsInN0cmVhbSIsInRvU3FsU3RyaW5nIiwiaGlzcWwiLCJsYW5ndWFnZSIsImlnbm9yZUlsbGVnYWxzIiwiY29uc29sZSIsImxvZyIsInJlc3VsdHMiLCJyZXNvbHZlIiwicHJvbWlzZSIsIlByb21pc2UiLCJyIiwiZG9uZSIsImVyciIsImNhbGxiYWNrIiwicmVqZWN0IiwiZ2V0Q29ubmVjdGlvbiIsInJlbGVhc2UiLCJ0cmFuc2FjdGlvbiIsImFsbFNldHRsZWQiLCJtYXAiLCJtYXBwZWQiLCJ6aXAiLCJ4IiwiaSIsImluZGV4IiwicmVzdWx0IiwiZXJyb3JzIiwiZmlsdGVyIiwic3RhdHVzIiwicmVhc29uIiwiUG9vbENvbm5lY3Rpb24iLCJjbG9zZSIsImVuZCIsImEiLCJiIiwiZXJyb3IiLCJmaWVsZHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQTs7QUFDQTs7Ozs7Ozs7QUFzRUEsU0FBU0EsUUFBVCxDQUFr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QUFPLENBQUNELE9BQUQsQ0FBUDtBQUNILE9BSEQ7QUFJSCxLQVZNLENBQVA7QUFXSDs7QUFsQmdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbXlzcWwgZnJvbSAnbXlzcWwnO1xuaW1wb3J0IHtQb29sQ29uZmlnIGFzIF9Qb29sQ29uZmlnLCBQb29sLCBGaWVsZEluZm8gYXMgX0ZpZWxkSW5mb30gZnJvbSBcIm15c3FsXCI7XG5pbXBvcnQge3NxbCwgU3FsRnJhZ30gZnJvbSAnLi9TcWwnO1xuaW1wb3J0IGhpZ2hsaWdodCBmcm9tICdjbGktaGlnaGxpZ2h0JztcbmltcG9ydCB7R2VvbWV0cnlUeXBlfSBmcm9tIFwibXlzcWxcIjtcbmltcG9ydCBTcWxNb2RlIGZyb20gXCIuL1NxbE1vZGVcIjtcbmltcG9ydCB7UG9vbENvbm5lY3Rpb24gYXMgX1Bvb2xDb25uZWN0aW9ufSBmcm9tIFwibXlzcWxcIjtcblxuZXhwb3J0IGludGVyZmFjZSBQb29sQ29uZmlnIGV4dGVuZHMgT21pdDxfUG9vbENvbmZpZywndHlwZUNhc3QnfCdzdXBwb3J0QmlnTnVtYmVycyd8J2JpZ051bWJlclN0cmluZ3MnPiB7XG4gICAgLyoqXG4gICAgICogUHJpbnQgU1FMIHF1ZXJpZXMgdG8gU1RET1VUIGJlZm9yZSBleGVjdXRpbmcgdGhlbS5cbiAgICAgKi9cbiAgICBwcmludFF1ZXJpZXM/OiBib29sZWFuXG4gICAgdHlwZUNhc3Q/OiAoZmllbGQ6IEZpZWxkSW5mbywgbmV4dDogTmV4dEZuKSA9PiBhbnksXG4gICAgLyoqXG4gICAgICogQGRlcHJlY2F0ZWQgU2V0IGluIG15LmNuZiB1bmRlciBbbXlzcWxkXVxuICAgICAqL1xuICAgIHNxbE1vZGU/OiBTcWxNb2RlW118c3RyaW5nfG51bGwsXG4gICAgLyoqXG4gICAgICogRW5hYmxlIG9yIGRpc2FibGUgZm9yZWlnbiBrZXkgY2hlY2tzIGZvciB0aGUgY3VycmVudCBzZXNzaW9uLiBNYXkgZWFzZSBtaWdyYXRpb24gc2NyaXB0cywgYnV0IG5vdCByZWNvbW1lbmRlZFxuICAgICAqIGZvciBwcm9kdWN0aW9uIHVzYWdlLlxuICAgICAqL1xuICAgIGZvcmVpZ25LZXlDaGVja3M/OiBib29sZWFufG51bGwsXG4gICAgLyoqXG4gICAgICogSWYgdGhpcyB2YXJpYWJsZSBpcyBlbmFibGVkLCBVUERBVEUgYW5kIERFTEVURSBzdGF0ZW1lbnRzIHRoYXQgZG8gbm90IHVzZSBhIGtleSBpbiB0aGUgV0hFUkUgY2xhdXNlIG9yIGEgTElNSVQgY2xhdXNlIHByb2R1Y2UgYW4gZXJyb3IuIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgdG8gY2F0Y2ggVVBEQVRFIGFuZCBERUxFVEUgc3RhdGVtZW50cyB3aGVyZSBrZXlzIGFyZSBub3QgdXNlZCBwcm9wZXJseSBhbmQgdGhhdCB3b3VsZCBwcm9iYWJseSBjaGFuZ2Ugb3IgZGVsZXRlIGEgbGFyZ2UgbnVtYmVyIG9mIHJvd3MuXG4gICAgICpcbiAgICAgKiBAbGluayBodHRwczovL21hcmlhZGIuY29tL2tiL2VuL2xpYnJhcnkvc2VydmVyLXN5c3RlbS12YXJpYWJsZXMvI3NxbF9zYWZlX3VwZGF0ZXNcbiAgICAgKiBAbGluayBodHRwczovL2Rldi5teXNxbC5jb20vZG9jL3JlZm1hbi84LjAvZW4vc2VydmVyLXN5c3RlbS12YXJpYWJsZXMuaHRtbCNzeXN2YXJfc3FsX3NhZmVfdXBkYXRlc1xuICAgICAqIEBkZXByZWNhdGVkIFNldCBpbiBteS5jbmYgdW5kZXIgW215c3FsZF1cbiAgICAgKi9cbiAgICBzYWZlVXBkYXRlcz86IGJvb2xlYW58bnVsbCxcbiAgICAvKipcbiAgICAgKiBBcnJheSBvZiBTUUwgc3RhdGVtZW50cyB0byBleGVjdXRlIHVwb24gY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBpbml0U3FsPzogQXJyYXk8U3FsRnJhZz5cbn1cblxuXG5leHBvcnQgdHlwZSBOZXh0Rm4gPSAoKSA9PiB2b2lkXG5leHBvcnQgdHlwZSBUeXBlcyA9ICdERUNJTUFMJ3wnVElOWSd8J1NIT1JUJ3wnTE9ORyd8J0ZMT0FUJ3wnRE9VQkxFJ3wnTlVMTCd8J1RJTUVTVEFNUCd8J0xPTkdMT05HJ3wnSU5UMjQnfCdEQVRFJ3wnVElNRSd8J0RBVEVUSU1FJ3wnWUVBUid8J05FV0RBVEUnfCdWQVJDSEFSJ3wnQklUJ3wnVElNRVNUQU1QMid8J0RBVEVUSU1FMid8J1RJTUUyJ3wnSlNPTid8J05FV0RFQ0lNQUwnfCdFTlVNJ3wnU0VUJ3wnVElOWV9CTE9CJ3wnTUVESVVNX0JMT0InfCdMT05HX0JMT0InfCdCTE9CJ3wnVkFSX1NUUklORyd8J1NUUklORyd8J0dFT01FVFJZJ1xuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkSW5mbyB7XG4gICAgY2F0YWxvZzogc3RyaW5nO1xuICAgIGRiOiBzdHJpbmc7XG4gICAgdGFibGU6IHN0cmluZztcbiAgICBvcmdUYWJsZTogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBvcmdOYW1lOiBzdHJpbmc7XG4gICAgY2hhcnNldE5yOiBudW1iZXI7XG4gICAgbGVuZ3RoOiBudW1iZXI7XG4gICAgdHlwZTogVHlwZXM7XG4gICAgZmxhZ3M6IG51bWJlcjtcbiAgICBkZWNpbWFsczogbnVtYmVyO1xuICAgIGRlZmF1bHQ/OiBzdHJpbmc7XG4gICAgemVyb0ZpbGw6IGJvb2xlYW47XG4gICAgcHJvdG9jb2w0MTogYm9vbGVhbjtcbiAgICBzdHJpbmcoKTogc3RyaW5nIHwgbnVsbCxcbiAgICBidWZmZXIoKTogQnVmZmVyIHwgbnVsbCxcbiAgICBnZW9tZXRyeSgpOiBHZW9tZXRyeVR5cGUgfCBudWxsLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9rUGFja2V0IHtcbiAgICBmaWVsZENvdW50OiBudW1iZXIsXG4gICAgYWZmZWN0ZWRSb3dzOiBudW1iZXIsXG4gICAgaW5zZXJ0SWQ6IG51bWJlcixcbiAgICBzZXJ2ZXJTdGF0dXM6IG51bWJlcixcbiAgICB3YXJuaW5nQ291bnQ6IG51bWJlcixcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgcHJvdG9jb2w0MTogYm9vbGVhbixcbiAgICBjaGFuZ2VkUm93czogbnVtYmVyXG59XG5cblxuZnVuY3Rpb24gdHlwZUNhc3QoZmllbGQ6IEZpZWxkSW5mbywgbmV4dDogTmV4dEZuKTogYW55IHtcbiAgICBzd2l0Y2ggKGZpZWxkLnR5cGUpIHtcbiAgICAgICAgY2FzZSAnREFURSc6XG4gICAgICAgIGNhc2UgJ0RBVEVUSU1FJzpcbiAgICAgICAgY2FzZSAnREFURVRJTUUyJzpcbiAgICAgICAgY2FzZSAnTkVXREFURSc6XG4gICAgICAgIGNhc2UgJ1RJTUVTVEFNUCc6XG4gICAgICAgIGNhc2UgJ1RJTUVTVEFNUDInOlxuICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL215c3FsanMvbXlzcWwjdHlwZS1jYXN0aW5nXG4gICAgICAgICAgICByZXR1cm4gZmllbGQuc3RyaW5nKCk7XG4gICAgICAgIGNhc2UgJ0xPTkdMT05HJzpcbiAgICAgICAgICAgIGNvbnN0IG51bWJlclN0cmluZyA9IGZpZWxkLnN0cmluZygpO1xuICAgICAgICAgICAgcmV0dXJuIG51bWJlclN0cmluZyA9PT0gbnVsbCA/IG51bGwgOiBCaWdJbnQobnVtYmVyU3RyaW5nKTtcbiAgICAgICAgY2FzZSAnQklUJzpcbiAgICAgICAgICAgIGlmIChmaWVsZC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBidWYgPSBmaWVsZC5idWZmZXIoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYnVmID09PSBudWxsID8gbnVsbCA6IGJ1ZlswXSA9PT0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gbmV4dCgpO1xufVxuXG5leHBvcnQgY2xhc3MgQ29ubmVjdGlvblBvb2wge1xuICAgIHByaXZhdGUgcG9vbDogUG9vbDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogUG9vbENvbmZpZztcblxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogUG9vbENvbmZpZykge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgICAgICAgIHRpbWV6b25lOiAnWicsXG4gICAgICAgICAgICBjaGFyc2V0OiAndXRmOG1iNCcsXG4gICAgICAgICAgICB0eXBlQ2FzdCxcbiAgICAgICAgICAgIC4uLmNvbmZpZyxcbiAgICAgICAgfTtcbiAgICAgICAgbGV0IHtzcWxNb2RlLGZvcmVpZ25LZXlDaGVja3Msc2FmZVVwZGF0ZXMscHJpbnRRdWVyaWVzLGluaXRTcWwsLi4ub3RoZXJ9ID0gdGhpcy5jb25maWc7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKG90aGVyKTtcbiAgICAgICAgdGhpcy5wb29sID0gbXlzcWwuY3JlYXRlUG9vbChvdGhlcik7XG5cbiAgICAgICAgY29uc3QgY29ublF1ZXJpZXMgPSBpbml0U3FsID8gWy4uLmluaXRTcWxdIDogW107XG4gICAgICAgIGlmKHNxbE1vZGUgIT0gbnVsbCkge1xuICAgICAgICAgICAgY29ublF1ZXJpZXMucHVzaChzcWxgU0VUIHNxbF9tb2RlPSR7QXJyYXkuaXNBcnJheShzcWxNb2RlKSA/ICBzcWxNb2RlLmpvaW4oJywnKSA6IHNxbE1vZGV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYoZm9yZWlnbktleUNoZWNrcyAhPSBudWxsKSB7XG4gICAgICAgICAgICBjb25uUXVlcmllcy5wdXNoKHNxbGBTRVQgZm9yZWlnbl9rZXlfY2hlY2tzPSR7Zm9yZWlnbktleUNoZWNrcyA/IDEgOiAwfWApO1xuICAgICAgICB9XG4gICAgICAgIGlmKHNhZmVVcGRhdGVzKSB7XG4gICAgICAgICAgICBjb25uUXVlcmllcy5wdXNoKHNxbGBTRVQgc3FsX3NhZmVfdXBkYXRlcz0ke3NhZmVVcGRhdGVzID8gMSA6IDB9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYoY29ublF1ZXJpZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLnBvb2wub24oJ2Nvbm5lY3Rpb24nLCAoX2Nvbm46IF9Qb29sQ29ubmVjdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbm4gPSB0aGlzLl93cmFwKF9jb25uKTtcbiAgICAgICAgICAgICAgICBmb3IoY29uc3QgcXVlcnkgb2YgY29ublF1ZXJpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubi5xdWVyeShxdWVyeSk7IC8vIFRPRE86IGRvIHdlIG5lZWQgdG8gd2FpdCBmb3IgdGhlc2UgcXVlcmllcyB0byBmaW5pc2guLi4/XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBxdWVyeTxUUmVjb3JkIGV4dGVuZHMgb2JqZWN0PVJlY29yZDxzdHJpbmcsYW55Pj4ocXVlcnk6IFNxbEZyYWcpOiBQcm9taXNlPFRSZWNvcmRbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy53aXRoQ29ubmVjdGlvbihjb25uID0+IGNvbm4ucXVlcnkocXVlcnkpKVxuICAgIH1cblxuICAgIGFzeW5jIHJvdzxUUmVjb3JkIGV4dGVuZHMgb2JqZWN0PVJlY29yZDxzdHJpbmcsYW55Pj4ocXVlcnk6IFNxbEZyYWcpOiBQcm9taXNlPFRSZWNvcmR8bnVsbD4ge1xuICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgdGhpcy5xdWVyeTxUUmVjb3JkPihzcWxgc2VsZWN0ICogZnJvbSAoJHtxdWVyeX0pIF9xdWVyeSBsaW1pdCAxYClcbiAgICAgICAgcmV0dXJuIHJvd3MubGVuZ3RoID8gcm93c1swXSA6IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgdmFsdWU8VFZhbHVlPXN0cmluZz4ocXVlcnk6IFNxbEZyYWcpOiBQcm9taXNlPFRWYWx1ZXxudWxsPiB7XG4gICAgICAgIGNvbnN0IHJvdyA9IGF3YWl0IHRoaXMucm93KHF1ZXJ5KVxuICAgICAgICBpZighcm93KSByZXR1cm4gbnVsbFxuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocm93KVxuICAgICAgICBpZihrZXlzLmxlbmd0aCAhPT0gMSkgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBleGFjdGx5IDEgZmllbGQgaW4gcXVlcnksIGdvdCAke2tleXMubGVuZ3RofWApXG4gICAgICAgIHJldHVybiByb3dba2V5c1swXV1cbiAgICB9XG5cbiAgICBhc3luYyBleGlzdHM8VFZhbHVlPXN0cmluZz4ocXVlcnk6IFNxbEZyYWcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIEJvb2xlYW4oYXdhaXQgdGhpcy52YWx1ZTwwfDE+KHNxbGBzZWxlY3QgZXhpc3RzKCR7cXVlcnl9KWApKVxuICAgIH1cblxuICAgIGV4ZWMocXVlcnk6IFNxbEZyYWcpOiBQcm9taXNlPE9rUGFja2V0PiB7XG4gICAgICAgIHJldHVybiB0aGlzLndpdGhDb25uZWN0aW9uKGNvbm4gPT4gY29ubi5xdWVyeShxdWVyeSkpXG4gICAgfVxuXG4gICAgYXN5bmMqIHN0cmVhbTxUUmVjb3JkIGV4dGVuZHMgb2JqZWN0ID0gUmVjb3JkPHN0cmluZywgYW55Pj4ocXVlcnk6IFNxbEZyYWcpOiBBc3luY0dlbmVyYXRvcjxUUmVjb3JkLCB2b2lkLCBhbnk+IHtcbiAgICAgICAgY29uc3Qgc3FsID0gcXVlcnkudG9TcWxTdHJpbmcoKTtcblxuICAgICAgICBpZiAodGhpcy5jb25maWcucHJpbnRRdWVyaWVzKSB7XG4gICAgICAgICAgICBjb25zdCBoaXNxbCA9IGhpZ2hsaWdodChzcWwsIHtsYW5ndWFnZTogJ3NxbCcsIGlnbm9yZUlsbGVnYWxzOiB0cnVlfSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhoaXNxbCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVzdWx0czogVFJlY29yZFtdID0gW107XG4gICAgICAgIGxldCByZXNvbHZlOiAoKSA9PiB2b2lkO1xuICAgICAgICBsZXQgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHIgPT4gcmVzb2x2ZSA9IHIpO1xuICAgICAgICBsZXQgZG9uZSA9IGZhbHNlO1xuXG4gICAgICAgIHRoaXMucG9vbC5xdWVyeShzcWwpXG4gICAgICAgICAgICAub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdyZXN1bHQnLCByb3cgPT4ge1xuICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChyb3cpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICBwcm9taXNlID0gbmV3IFByb21pc2UociA9PiByZXNvbHZlID0gcik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICBmb3IoOzspIHtcbiAgICAgICAgICAgIGF3YWl0IHByb21pc2U7XG4gICAgICAgICAgICB5aWVsZCogcmVzdWx0cztcbiAgICAgICAgICAgIGlmKGRvbmUpIGJyZWFrXG4gICAgICAgICAgICByZXN1bHRzID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB3aXRoQ29ubmVjdGlvbjxUUmVzdWx0PihjYWxsYmFjazogKGNvbm46UG9vbENvbm5lY3Rpb24pID0+IFByb21pc2U8VFJlc3VsdD4pOiBQcm9taXNlPFRSZXN1bHQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucG9vbC5nZXRDb25uZWN0aW9uKGFzeW5jIChlcnIsIGNvbm4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShjYWxsYmFjayh0aGlzLl93cmFwKGNvbm4pKSk7XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgY29ubi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdHJhbnNhY3Rpb248VFJlc3VsdD4oY2FsbGJhY2s6ICgoY29ubjpQb29sQ29ubmVjdGlvbikgPT4gUHJvbWlzZTxUUmVzdWx0Pil8U3FsRnJhZ1tdKTogUHJvbWlzZTxUUmVzdWx0PiB7XG4gICAgICAgIGlmKEFycmF5LmlzQXJyYXkoY2FsbGJhY2spKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbjxhbnk+KGFzeW5jIGNvbm4gPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoY2FsbGJhY2subWFwKHNxbCA9PiBjb25uLnF1ZXJ5KHNxbCkpKVxuICAgICAgICAgICAgICAgIGNvbnN0IG1hcHBlZCA9IHppcChjYWxsYmFjaywgcmVzdWx0cykubWFwKCh4LGkpID0+ICh7XG4gICAgICAgICAgICAgICAgICAgIGluZGV4OiBpLFxuICAgICAgICAgICAgICAgICAgICBxdWVyeTogeFswXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiB4WzFdLFxuICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9ycyA9IG1hcHBlZC5maWx0ZXIociA9PiByLnJlc3VsdC5zdGF0dXMgPT09ICdyZWplY3RlZCcpO1xuICAgICAgICAgICAgICAgIGlmKGVycm9ycy5sZW5ndGgpIHRocm93IEVycm9yKGAke2Vycm9ycy5sZW5ndGh9IHF1ZXIke2Vycm9ycy5sZW5ndGggPT09IDEgPyAneScgOiAnaWVzJ30gZmFpbGVkOiR7ZXJyb3JzLm1hcChlcnIgPT4gYFxcblske2Vyci5pbmRleH1dICR7ZXJyLnF1ZXJ5LnRvU3FsU3RyaW5nKCl9IDo6ICR7KGVyci5yZXN1bHQgYXMgYW55KS5yZWFzb259YCkuam9pbignJyl9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7IC8vIFRPRE86IGlzIHRoaXMgdGhlIGJlc3QgZm9ybWF0IGZvciB0aGUgcmVzdWx0cz9cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLndpdGhDb25uZWN0aW9uKGFzeW5jIGNvbm4gPT4ge1xuICAgICAgICAgICAgYXdhaXQgY29ubi5xdWVyeShzcWxgU1RBUlQgVFJBTlNBQ1RJT05gKTtcbiAgICAgICAgICAgIGxldCByZXN1bHQ6IFRSZXN1bHQ7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IGNhbGxiYWNrKGNvbm4pO1xuICAgICAgICAgICAgfSBjYXRjaChlcnIpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBjb25uLnF1ZXJ5KHNxbGBST0xMQkFDS2ApO1xuICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGF3YWl0IGNvbm4ucXVlcnkoc3FsYENPTU1JVGApO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBwcml2YXRlIF93cmFwKGNvbm46IF9Qb29sQ29ubmVjdGlvbikge1xuICAgICAgICByZXR1cm4gbmV3IFBvb2xDb25uZWN0aW9uKGNvbm4sICEhdGhpcy5jb25maWcucHJpbnRRdWVyaWVzKTtcbiAgICB9XG5cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucG9vbC5lbmQoZXJyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHppcDxBLEI+KGE6IEFbXSwgYjogQltdKTogQXJyYXk8W0EsQl0+IHtcbiAgICBpZihhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCB6aXAgYXJyYXlzOyBsZW5ndGhzIGRpZmZlclwiKTtcbiAgICByZXR1cm4gYS5tYXAoKHgsaSkgPT4gW3gsYltpXV0pO1xufVxuXG5jbGFzcyBQb29sQ29ubmVjdGlvbiB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGNvbm46IF9Qb29sQ29ubmVjdGlvbiwgcHJpdmF0ZSByZWFkb25seSBwcmludFF1ZXJpZXM6IGJvb2xlYW4pIHtcblxuICAgIH1cblxuICAgIHF1ZXJ5KHF1ZXJ5OiBTcWxGcmFnKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNxbCA9IHF1ZXJ5LnRvU3FsU3RyaW5nKCk7XG4gICAgICAgICAgICBpZiAodGhpcy5wcmludFF1ZXJpZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBoaXNxbCA9IGhpZ2hsaWdodChzcWwsIHtsYW5ndWFnZTogJ3NxbCcsIGlnbm9yZUlsbGVnYWxzOiB0cnVlfSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coaGlzcWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jb25uLnF1ZXJ5KHNxbCwgKGVycm9yLCByZXN1bHRzLCBmaWVsZHMpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHJldHVybiByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH1cbn1cbiJdfQ==